{% extends "base.html" %}
{% block title %}{% if edit_mode %}Edit Question Paper{% else %}Create Question Paper{% endif %} - ExamPro{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6 editor-light" 
     {% if edit_mode and qpaper %}data-edit-mode="true" data-qpaper-id="{{ qpaper.id }}" data-exam-id="{{ exam_id|default:'' }}"{% endif %}>
<style>
/* Page-local light theme: increase border contrast for visible professional UI */
.editor-light { background: transparent; color: inherit; padding: 0; }
.editor-light .card { background: #ffffff !important; border-color: #cbd5e1 !important; color: inherit; box-shadow: 0 1px 2px rgba(2,6,23,0.04); }
.editor-light .muted { color: #94a3b8; }
.editor-light input[type="text"], .editor-light input[type="number"], .editor-light textarea {
    background: #ffffff; color: #0f172a; border: 1px solid #cbd5e1; padding: .5rem .75rem; border-radius: .5rem;
}
.editor-light label { color: #475569 }
.editor-light .option-text { background: transparent; color: #0f172a; border: none; padding: 0; }
.editor-light .option-input { background:#ffffff; color:#0f172a; border:1px solid #cbd5e1; padding:.6rem .8rem; border-radius:.5rem; width:100%; }
.editor-light .max-marks { width:72px; padding: .375rem .9rem; border:1px solid #cbd5e1; border-radius: .5rem; text-align: right; }
.editor-light .max-marks::-webkit-outer-spin-button,
.editor-light .max-marks::-webkit-inner-spin-button {
    margin-left: 6px;
}
.editor-light .card .border-slate-100 { border-color: #e6eef8 !important; }
</style>

    <!-- Header with back button for edit mode -->
    {% if edit_mode and exam_id %}
    <div class="flex items-center gap-4">
        <a href="{% url 'faculty-edit_exam_enhanced' exam_id %}" class="p-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Edit Question Paper</h1>
            <p class="text-slate-500">Modify questions and save your changes</p>
        </div>
    </div>
    {% endif %}

    {% if edit_mode %}
    <!-- Edit mode header -->
    <div class="card bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-10">
        <div>
            <h1 class="text-xl font-bold text-slate-900">Edit Question Paper</h1>
            <p class="text-slate-500 text-sm">Modify your question paper</p>
        </div>
        <div class="flex items-center gap-4">
            <input id="qpaper-title" type="text" placeholder="Question Paper Title" value="{{ qpaper.qPaperTitle|default:'' }}" class="w-full md:w-64 rounded-lg border-slate-300 px-3 py-2">
            <input id="qpaper-total-marks" type="number" min="1" step="1" placeholder="Total Marks" value="{{ qpaper.total_marks|default:'' }}" class="w-32 rounded-lg border-slate-300 px-3 py-2">
            <input type="hidden" id="qpaper-id" value="{{ qpaper.id }}">
            <div class="text-sm text-slate-500">Remaining: <span id="remaining-marks">0</span></div>
        </div>
    </div>
    {% else %}
    <div class="card bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-10">
        <div>
            <h1 class="text-xl font-bold text-slate-900">Create Question Paper</h1>
            <p class="text-slate-500 text-sm">Build your question paper</p>
        </div>
        <div class="flex items-center gap-4">
            <input id="qpaper-title" type="text" placeholder="Question Paper Title" class="w-full md:w-64 rounded-lg border-slate-300 px-3 py-2">
            <input id="qpaper-total-marks" type="number" min="1" step="1" placeholder="Total Marks" class="w-32 rounded-lg border-slate-300 px-3 py-2">
            <div class="text-sm text-slate-500">Remaining: <span id="remaining-marks">0</span></div>
        </div>
    </div>
    {% endif %}

    <div id="questions-container" class="space-y-6">
        <!-- Question cards inserted here -->
    </div>

    <div class="flex gap-4 justify-between">
        <button id="add-question" class="px-6 py-2 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-slate-50">âž• Add Another Question</button>
        <button id="save-paper" class="px-6 py-2 bg-primary hover:bg-indigo-700 text-white font-bold rounded-xl">ðŸ’¾ {% if edit_mode %}Update{% else %}Save{% endif %}</button>
    </div>
</div>

<script>
    // Helper to create one question card (editable fields)
    var qIndex = 0;
    var totalMarks = 0;
    var remainingMarks = 0;
    
    // Edit mode variables - default values
    var isEditMode = false;
    var existingQPaperId = null;
    var examIdForRedirect = null;

    // Check for edit mode from data attributes
    (function() {
        var container = document.querySelector('.editor-light');
        if (container && container.dataset.editMode === 'true') {
            isEditMode = true;
            existingQPaperId = parseInt(container.dataset.qpaperId) || null;
            examIdForRedirect = container.dataset.examId || null;
            
            // Fetch existing question paper data on DOM ready
            if (existingQPaperId) {
                loadExistingQuestions();
            }
        }
        
        function loadExistingQuestions() {
            fetch('/exams/prof/api/questionpaper/' + existingQPaperId + '/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data && data.questions) {
                        // Set title and total marks
                        document.getElementById('qpaper-title').value = data.title || '';
                        document.getElementById('qpaper-total-marks').value = data.total_marks || 0;
                        totalMarks = data.total_marks || 0;
                        remainingMarks = data.total_marks || 0;
                        document.getElementById('remaining-marks').textContent = remainingMarks;
                        
                        // Load existing questions
                        data.questions.forEach(function(q) {
                            addNewQuestion({
                                question: q.question,
                                optionA: q.optionA,
                                optionB: q.optionB,
                                optionC: q.optionC,
                                optionD: q.optionD,
                                answer: q.answer,
                                max_marks: q.max_marks
                            });
                        });
                    }
                })
                .catch(function(err) {
                    console.error('Error loading question paper:', err);
                });
        }
    })();

    function createQuestionCard(data) {
        qIndex++;
        var qNum = qIndex;
        var container = document.createElement('div');
        container.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card';
        container.dataset.index = qNum;

        var header = document.createElement('div');
        header.className = 'p-6 border-b border-slate-100 bg-slate-100';
        header.innerHTML = '<h3 class="font-semibold text-slate-900 flex gap-3"><span class="text-slate-400">Q' + qNum + '.</span><textarea class="question-text w-full bg-transparent resize-none" rows="2" placeholder="Enter question text"></textarea></h3><p class="text-xs text-slate-400 mt-2 text-right">Marks: <input type="number" min="0" step="1" class="max-marks w-20 text-right border-none bg-transparent" value="0"></p>';

        var body = document.createElement('div');
        body.className = 'p-6 space-y-3';

        // Create four options
        var letters = ['A', 'B', 'C', 'D'];
        for (var i = 0; i < letters.length; i++) {
            var letter = letters[i];
            var label = document.createElement('label');
            label.className = 'flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-slate-100 hover:border-slate-300 cursor-pointer transition-all group';
            label.innerHTML = '<input type="radio" name="correct-' + qNum + '" value="' + letter + '" class="w-4 h-4 text-primary border-slate-300 focus:ring-primary"><input type="text" class="option-input option-text" placeholder="Option ' + letter + '">';
            body.appendChild(label);
        }

        container.appendChild(header);
        container.appendChild(body);

        // populate if provided
        if (data) {
            container.querySelector('.question-text').value = data.question || '';
            container.querySelector('.max-marks').value = data.max_marks || 0;
            var opts = container.querySelectorAll('.option-text');
            opts[0].value = data.optionA || '';
            opts[1].value = data.optionB || '';
            opts[2].value = data.optionC || '';
            opts[3].value = data.optionD || '';
            var radios = container.querySelectorAll('input[type=radio][name="correct-' + qNum + '"]');
            for (var r = 0; r < radios.length; r++) {
                if (radios[r].value === (data.answer || '')) {
                    radios[r].checked = true;
                }
            }
        }

        // marks input behavior
        (function() {
            var mm = container.querySelector('.max-marks');
            if (!mm) return;
            mm.dataset.prev = mm.value || '0';
            mm.addEventListener('focus', function() { 
                try { this.select(); this.dataset.prev = this.value || '0'; } catch(e) {} 
            });
            mm.addEventListener('input', function() {
                var cards = document.querySelectorAll('#questions-container > div');
                var sumOther = 0;
                for (var c = 0; c < cards.length; c++) {
                    if (cards[c] === container) continue;
                    var val = parseInt(cards[c].querySelector('.max-marks').value) || 0;
                    sumOther += val;
                }
                var allowed = (totalMarks || 0) - sumOther;
                var v = parseInt(this.value) || 0;
                if (v > allowed) {
                    alert('Marks exceed remaining total.');
                    this.value = this.dataset.prev || '0';
                    onMarksChange();
                    return;
                }
                this.dataset.prev = String(v);
                onMarksChange();
            });
        })();

        return container;
    }

    function addNewQuestion(data) {
        var card = createQuestionCard(data);
        document.getElementById('questions-container').appendChild(card);
        var mm = card.querySelector('.max-marks');
        mm.addEventListener('input', onMarksChange);
    }

    function initFirstCardIfNeeded() {
        if (qIndex === 0 && totalMarks > 0) {
            addNewQuestion();
            remainingMarks = totalMarks;
            document.getElementById('remaining-marks').textContent = remainingMarks;
        }
    }

    document.getElementById('qpaper-total-marks').addEventListener('change', function(e) {
        var v = parseInt(this.value) || 0;
        if (v <= 0) { alert('Total marks must be a positive number'); this.value = ''; return; }
        totalMarks = v;
        remainingMarks = totalMarks;
        document.getElementById('remaining-marks').textContent = remainingMarks;
        if (qIndex === 0) addNewQuestion();
    });

    document.getElementById('add-question').addEventListener('click', function(e) {
        e.preventDefault();
        if (totalMarks <= 0) { alert('Please enter total marks first'); return; }
        if (remainingMarks <= 0) { alert('No remaining marks available for another question'); return; }
        addNewQuestion();
    });

    function onMarksChange(e) {
        var cards = document.querySelectorAll('#questions-container > div');
        var sum = 0;
        for (var c = 0; c < cards.length; c++) {
            var v = parseInt(cards[c].querySelector('.max-marks').value) || 0;
            sum += v;
        }
        remainingMarks = totalMarks - sum;
        if (remainingMarks < 0) {
            alert('Marks exceed total marks. Please adjust.');
            remainingMarks = 0;
        }
        document.getElementById('remaining-marks').textContent = remainingMarks;
        for (var c = 0; c < cards.length; c++) {
            var mm = cards[c].querySelector('.max-marks');
            if (!mm) continue;
            var cur = parseInt(mm.value) || 0;
            mm.max = cur + remainingMarks;
        }
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('save-paper').addEventListener('click', function(e) {
        e.preventDefault();
        var title = document.getElementById('qpaper-title').value.trim();
        if (!title) { alert('Please enter a question paper title.'); return; }
        if (totalMarks <= 0) { alert('Please set total marks for the question paper.'); return; }

        var cards = document.querySelectorAll('#questions-container > div');
        var questions = [];
        for (var c = 0; c < cards.length; c++) {
            var card = cards[c];
            var qtext = card.querySelector('.question-text').value.trim();
            var optEls = card.querySelectorAll('.option-text');
            var optionA = optEls[0].value.trim();
            var optionB = optEls[1].value.trim();
            var optionC = optEls[2].value.trim();
            var optionD = optEls[3].value.trim();
            var max_marks = parseInt(card.querySelector('.max-marks').value) || 0;
            var correct = card.querySelector('input[type=radio][name="correct-' + card.dataset.index + '"]:checked');
            var answer = correct ? correct.value : '';

            if (!qtext || !optionA || !optionB || !optionC || !optionD || !['A', 'B', 'C', 'D'].includes(answer)) {
                alert('Please fill all fields and select the correct answer for each question.');
                return;
            }

            if (max_marks <= 0) { alert('Each question must have positive marks.'); return; }

            questions.push({ question: qtext, optionA: optionA, optionB: optionB, optionC: optionC, optionD: optionD, answer: answer, max_marks: max_marks });
        }

        var sumMarks = 0;
        for (var q = 0; q < questions.length; q++) {
            sumMarks += parseInt(questions[q].max_marks);
        }
        if (sumMarks !== totalMarks) { alert('Total of question marks (' + sumMarks + ') must equal Question Paper total marks (' + totalMarks + ').'); return; }

        // send via fetch
        var saveUrl = "{% url 'faculty-save-question-paper' %}";
        var saveData = { title: title, total_marks: totalMarks, questions: questions };
        
        if (isEditMode && existingQPaperId) {
            saveUrl = "{% url 'faculty-update-question-paper' %}";
            saveData = { qpaper_id: existingQPaperId, title: title, total_marks: totalMarks, questions: questions };
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', saveUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        window.location.href = data.redirect || '/exams/prof/viewexams/';
                    } else {
                        alert(data.error || 'Save failed');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Save failed');
                }
            }
        };
        xhr.send(JSON.stringify(saveData));
    });
</script>

{% endblock %}
